# 动计笔记 - 技术架构方案

## 推荐技术栈（2025）

### 核心框架

| 组件 | 技术选型 | 版本要求 | 说明 |
|------|----------|----------|------|
| **开发语言** | Dart | 3.0+ | 空安全支持 |
| **UI框架** | Flutter | 3.19+ | 稳定版 |
| **状态管理** | **Riverpod** | 2.4+ | 推荐直接使用 |
| **路由管理** | **go_router** | 13.0+ | 类型安全，深链接支持 |
| **本地数据库** | **Drift** | 2.14+ | 关系查询，编译时安全 |
| **网络请求** | dio | 5.4+ | 功能完整 |
| **本地存储** | shared_preferences | 2.2+ | 简单 KV 存储 |
| **日期处理** | intl | 0.19+ | 日期格式化 |
| **图表** | fl_chart | 0.67+ | 图表展示 |
| **富文本** | flutter_quill | 9.0+ | 后期功能 |
| **推送** | flutter_local_notifications | 16.0+ | 本地推送 |
| **定位** | geolocator | 11.0+ | GPS 追踪（后期） |
| **健康** | **huawei_health** | - | 华为健康集成（后期） |
| **图片选择** | image_picker | 1.0+ | 图片上传（后期） |
| **文件处理** | path_provider | 2.1+ | 本地路径 |
| **AI服务** | DeepSeek API | - | AI 功能（后期） |

---

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Presentation Layer                      │
│  ┌──────────────┬──────────────┬──────────────┬────────────┐ │
│  │   Notes UI   │ Reminders UI │  Workout UI  │  Plans UI  │ │
│  └──────┬───────┴──────┬───────┴──────┬───────┴─────┬──────┘ │
│         └──────────────┼───────────────┼──────────────┘      │
│                        ↓               ↓                     │
│                    ┌─────────────────────────────┐           │
│                    │    Riverpod Providers        │           │
│                    │  (State Management Layer)    │           │
│                    └──────────────┬──────────────┘           │
├───────────────────────────────────┼───────────────────────────┤
│                        ↓           ↓                           │
│                      Domain Layer (可选)                      │
│                    ┌─────────────────────┐                    │
│                    │   Use Cases / Repositories             │ │
│                    └──────────────┬──────┘                    │
├───────────────────────────────────┼───────────────────────────┤
│                        ↓           ↓                           │
│                       Data Layer                           │
│  ┌──────────────┬──────────────┬──────────────────────┐       │
│  │    Drift     │  Local API  │   Remote API (后期)   │       │
│  │   Database   │   Services  │   (DeepSeek/Cloud)    │       │
│  └──────────────┴──────────────┴──────────────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 项目结构

```
lib/
├── main.dart                      # 应用入口
│
├── core/                          # 核心层
│   ├── config/
│   │   ├── app_config.dart        # 应用配置
│   │   └── router_config.dart     # 路由配置
│   ├── constants/
│   │   ├── app_constants.dart     # 常量定义
│   │   └── storage_keys.dart      # 存储键
│   ├── theme/
│   │   ├── app_theme.dart         # 主题配置
│   │   └── app_colors.dart        # 颜色定义
│   ├── utils/
│   │   ├── date_utils.dart        # 日期工具
│   │   ├── validators.dart        # 验证器
│   │   └── extensions.dart        # 扩展方法
│   └── errors/
│       ├── exceptions.dart        # 异常定义
│       └── failures.dart          # 失败类型
│
├── shared/                        # 共享模块
│   ├── widgets/
│   │   ├── app_button.dart        # 通用按钮
│   │   ├── app_input.dart         # 通用输入框
│   │   ├── loading_widget.dart    # 加载组件
│   │   └── empty_state.dart       # 空状态
│   ├── models/                    # 共享数据模型
│   └── providers/                 # 全局 Providers
│
├── features/                      # 功能模块
│   │
│   ├── notes/                     # 记事本模块
│   │   ├── data/
│   │   │   ├── models/
│   │   │   │   └── note.dart
│   │   │   ├── repositories/
│   │   │   │   └── note_repository.dart
│   │   │   └── datasources/
│   │   │       └── note_local_datasource.dart
│   │   ├── presentation/
│   │   │   ├── providers/
│   │   │   │   └── note_provider.dart
│   │   │   ├── pages/
│   │   │   │   ├── note_list_page.dart
│   │   │   │   └── note_edit_page.dart
│   │   │   └── widgets/
│   │   │       ├── note_card.dart
│   │   │       └── tag_chip.dart
│   │   └── routes/
│   │       └── note_routes.dart
│   │
│   ├── reminders/                 # 提醒模块
│   │   └── (结构同 notes/)
│   │
│   ├── workout/                   # 运动模块
│   │   └── (结构同 notes/)
│   │
│   └── plans/                     # 计划模块
│       └── (结构同 notes/)
│
└── services/                      # 外部服务
    ├── database/                  # 数据库服务
    │   ├── app_database.dart      # Drift 数据库
    │   └── drift_schema.dart      # 数据表定义
    ├── notification/              # 推送服务
    │   └── notification_service.dart
    ├── storage/                   # 存储服务
    │   └── storage_service.dart
    └── ai/                        # AI 服务（后期）
        └── deepseek_service.dart
```

---

## 数据库设计（Drift）

### 核心数据表

```dart
// notes 表
@DataClassName('Note')
class Notes extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get title => text().nullable()();
  TextColumn get content => text()();
  TextColumn get tags => text()();  // JSON 存储标签数组
  DateTimeColumn get createdAt => dateTime()();
  DateTimeColumn get updatedAt => dateTime()();
  BoolColumn get isDeleted => boolean().withDefault(const Constant(false))();
}

// reminders 表
@DataClassName('Reminder')
class Reminders extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get title => text()();
  TextColumn get description => text().nullable()();
  DateTimeColumn get remindTime => dateTime()();
  BoolColumn get isDone => boolean().withDefault(const Constant(false))();
  DateTimeColumn get completedAt => dateTime().nullable()();
  TextColumn get repeatType => text().withDefault(const Constant('none'))(); // none/daily/weekly
  TextColumn get repeatDays => text().nullable()(); // JSON 存储星期数组
  IntColumn get linkedPlanId => references(Plans, #id).nullable()();
  IntColumn get linkedWorkoutId => references(Workouts, #id).nullable()();
}

// workouts 表
@DataClassName('Workout')
class Workouts extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get type => text()();  // 运动类型枚举
  TextColumn get customType => text().nullable()();
  DateTimeColumn get startTime => dateTime()();
  IntColumn get durationMinutes => integer()();
  TextColumn get notes => text().nullable()();
  IntColumn get sets => integer().nullable()();
  IntColumn get reps => integer().nullable()();
  DoubleColumn get weight => real().nullable()();
  TextColumn get feeling => text().nullable()();  // easy/medium/hard
  DoubleColumn get distance => real().nullable()();  // 距离（后期）
  DoubleColumn get calories => real().nullable()();  // 卡路里（后期）
  IntColumn get linkedPlanId => references(Plans, #id).nullable()();
  IntColumn get linkedNoteId => references(Notes, #id).nullable()();
}

// plans 表
@DataClassName('Plan')
class Plans extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get title => text()();
  TextColumn get description => text().nullable()();
  TextColumn get category => text()();  // workout/habit/study/work
  DateColumn get startDate => date()();
  DateColumn get targetDate => date()();
  TextColumn get status => text().withDefault(const Constant('active'))(); // active/completed/paused
  IntColumn get totalTasks => integer().withDefault(const Constant(0))();
  IntColumn get completedTasks => integer().withDefault(const Constant(0))();
  IntColumn get streakDays => integer().withDefault(const Constant(0))();
  BoolColumn get isAIGenerated => boolean().withDefault(const Constant(false))();
}

// plan_tasks 表
@DataClassName('PlanTask')
class PlanTasks extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get planId => references(Plans, #id)();
  TextColumn get title => text()();
  TextColumn get description => text().nullable()();
  DateColumn get scheduledDate => date()();
  BoolColumn get isCompleted => boolean().withDefault(const Constant(false))();
  DateTimeColumn get completedAt => dateTime().nullable()();
  TextColumn get taskType => text()();  // workout/note/reminder/general
  IntColumn get linkedItemId => integer().nullable()();  // 关联项目ID
  IntColumn get reminderId => references(Reminders, #id).nullable()();
}
```

---

## 状态管理（Riverpod）

### Provider 组织结构

```dart
// providers/note_providers.dart

// 数据仓库 Provider
@riverpod
NoteRepository noteRepository(NoteRepositoryRef ref) {
  return NoteRepository(ref.watch(databaseProvider));
}

// 笔记列表 Provider
@riverpod
Future<List<Note>> noteList(NoteListRef ref) async {
  final repo = ref.watch(noteRepositoryProvider);
  return repo.getAllNotes();
}

// 单个笔记 Provider
@riverpod
Future<Note> note(NoteRef ref, int id) async {
  final repo = ref.watch(noteRepositoryProvider);
  return repo.getNoteById(id);
}

// 按标签筛选 Provider
@riverpod
Future<List<Note>> notesByTag(NotesByTagRef ref, String tag) async {
  final repo = ref.watch(noteRepositoryProvider);
  return repo.getNotesByTag(tag);
}
```

### 使用示例

```dart
// 在 Widget 中使用
class NoteListPage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final notesAsync = ref.watch(noteListProvider);

    return Scaffold(
      appBar: AppBar(title: Text('笔记')),
      body: notesAsync.when(
        data: (notes) => ListView.builder(
          itemCount: notes.length,
          itemBuilder: (context, index) => NoteCard(note: notes[index]),
        ),
        loading: () => Center(child: CircularProgressIndicator()),
        error: (e, s) => Center(child: Text('加载失败: $e')),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => ref.read(noteListProvider.notifier).refresh(),
        child: Icon(Icons.refresh),
      ),
    );
  }
}
```

---

## 路由设计（go_router）

### 路由结构

```dart
// router_config.dart
final router = GoRouter(
  routes: [
    GoRoute(
      path: '/',
      builder: (context, state) => HomePage(),
    ),
    GoRoute(
      path: '/notes',
      builder: (context, state) => NoteListPage(),
      routes: [
        GoRoute(
          path: ':id',
          builder: (context, state) {
            final id = int.parse(state.pathParameters['id']!);
            return NoteDetailPage(noteId: id);
          },
        ),
        GoRoute(
          path: 'new',
          builder: (context, state) => NoteEditPage(),
        ),
      ],
    ),
    GoRoute(
      path: '/reminders',
      builder: (context, state) => ReminderListPage(),
    ),
    GoRoute(
      path: '/workout',
      builder: (context, state) => WorkoutHomePage(),
    ),
    GoRoute(
      path: '/plans',
      builder: (context, state) => PlanListPage(),
    ),
  ],
);
```

---

## 依赖管理

### pubspec.yaml

```yaml
name: thick_notepad
description: 动计笔记 - 记事+提醒+运动+计划一站式APP

version: 1.0.0+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter

  # 状态管理
  flutter_riverpod: ^2.4.9
  riverpod_annotation: ^2.3.3

  # 路由
  go_router: ^13.0.1

  # 数据库
  drift: ^2.14.1
  sqlite3_flutter_libs: ^0.5.18
  path_provider: ^2.1.2
  path: ^1.8.3

  # 本地存储
  shared_preferences: ^2.2.2

  # 网络
  dio: ^5.4.0

  # 日期
  intl: ^0.19.0

  # 图表
  fl_chart: ^0.67.0

  # 推送
  flutter_local_notifications: ^16.3.0

  # 图片选择（后期）
  image_picker: ^1.0.7

  # 工具
  freezed_annotation: ^2.4.1
  json_annotation: ^4.8.1

dev_dependencies:
  flutter_test:
    sdk: flutter

  # 代码生成
  build_runner: ^2.4.8
  drift_dev: ^2.14.1
  riverpod_generator: ^2.3.9
  freezed: ^2.4.6
  json_serializable: ^6.7.1

  # 代码检查
  flutter_lints: ^3.0.1
```

---

## 开发工具推荐

### VS Code 插件

| 插件 | 用途 |
|------|------|
| Flutter | Flutter 官方支持 |
| Dart | Dart 语言支持 |
| Riverpod Snippets | Riverpod 代码片段 |
| Awesome Flutter Snippets | Flutter 代码片段 |

### 代码生成命令

```bash
# 生成所有代码
flutter pub run build_runner build --delete-conflicting-outputs

# 监听模式（开发时使用）
flutter pub run build_runner watch --delete-conflicting-outputs
```

---

## 后期集成规划

### 云同步（阶段5+）

**推荐方案：PowerSync**

```yaml
dependencies:
  powersync: ^0.1.0
```

### 华为健康（阶段4+）

```yaml
dependencies:
  huawei_health: ^6.11.0  # 需要华为 HMS Core
```

### DeepSeek AI（阶段3+）

```dart
// services/deepseek_service.dart
class DeepSeekService {
  final dio = Dio(BaseOptions(
    baseUrl: 'https://api.deepseek.com/v1',
  ));

  Future<String> generatePlan(String goal) async {
    final response = await dio.post(
      '/chat/completions',
      options: Options(headers: {
        'Authorization': 'Bearer YOUR_API_KEY',
      }),
      data: {
        'model': 'deepseek-chat',
        'messages': [
          {'role': 'system', 'content': '你是一个运动计划制定助手...'},
          {'role': 'user', 'content': '帮我制定一个${goal}的计划'},
        ],
      },
    );
    return response.data['choices'][0]['message']['content'];
  }
}
```

---

## 性能优化建议

1. **分页加载** — 笔记/运动历史使用分页
2. **图片压缩** — 上传前压缩
3. **数据库索引** — 为常用查询字段建索引
4. **懒加载** — 列表使用 ListView.builder
5. **缓存策略** — 使用 Riverpod 的缓存机制

---

## 安全建议

1. **API Key** — 存储在 .env 文件，不提交到 Git
2. **本地加密** — 敏感数据使用 flutter_secure_storage
3. **生物识别** — 使用 local_auth 包
4. **代码混淆** — 发布时启用混淆

---

## 学习资源

| 资源 | 链接 |
|------|------|
| Riverpod 官方文档 | https://riverpod.dev |
| Drift 官方文档 | https://drift.simonbinder.eu |
| go_router 文档 | https://pub.dev/packages/go_router |
| Flutter 中文网 | https://flutter.cn |
