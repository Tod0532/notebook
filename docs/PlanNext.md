# 动计笔记 - 下一步计划

> 项目已稳定运行，进入功能完善阶段
> 更新时间：2026-01-30

---

## 📊 当前状态分析

### 项目里程碑 ✅

| 里程碑 | 日期 | 状态 |
|--------|------|------|
| 基础架构搭建 | 2025-01-29 | ✅ |
| 核心功能开发 | 2025-01-29 | ✅ |
| UI 框架完成 | 2025-01-29 | ✅ |
| 数据持久化 | 2025-01-29 | ✅ |
| 路由重构 | 2026-01-30 | ✅ |
| 真机测试通过 | 2026-01-30 | ✅ |
| **代码审查优化** | **2026-01-30** | **✅** |

### 代码质量达标 ✅

| 指标 | 状态 |
|------|------|
| 编译错误 | 0 |
| 警告 | 0 |
| 严重问题 | 已修复 |
| 内存泄漏 | 已修复 |
| 性能优化 | 已完成 |

### 代码审查成果 ✅

| 类别 | 成果 |
|------|------|
| 工具类提取 | ProviderInvalidator, DateFormatter |
| 性能提升 | RecentActivities 并行加载 ~60% |
| Bug 修复 | 4 个运行时问题修复 |
| 技术债务 | Provider 刷新、日期格式化统一 |

### 核心模块状态

| 模块 | UI | 数据层 | 业务逻辑 | 测试 |
|------|----| ---- | ---------- | ---- |
| 笔记 | ✅ | ✅ | ✅ | ✅ |
| 提醒 | ✅ | ✅ | ✅ | ✅ |
| 运动 | ✅ | ✅ | ✅ | ✅ |
| 计划 | ✅ | ✅ | ✅ | ✅ |
| 导航 | ✅ | - | ✅ | ✅ |

### 数据库关联字段（已预留）

```dart
// Workouts 表 - 运动记录
IntColumn get linkedPlanId;    // 关联的计划ID
IntColumn get linkedNoteId;    // 生成的笔记ID

// Reminders 表 - 提醒
IntColumn get linkedPlanId;    // 关联的计划ID
IntColumn get linkedWorkoutId; // 关联的运动ID

// PlanTasks 表 - 计划任务
IntColumn get reminderId;      // 关联的提醒ID
IntColumn get linkedItemId;    // 关联项目ID（运动/笔记）
```

### 待实现功能 ⚠️

| 功能 | 状态 | 说明 |
|------|------|------|
| **运动关联计划** | ❌ 未实现 | 保存运动时自动完成相关任务 |
| **任务关联提醒** | ❌ 未实现 | 创建任务时可选择添加提醒 |
| **运动生成笔记** | ❌ 未实现 | 运动后自动生成小结笔记 |
| **首页数据汇总** | ❌ 硬编码 | 显示真实数据而非固定值 |
| **通知推送集成** | ⚠️ 服务已创建 | 界面未调用 |
| **计划选择器** | ❌ 缺失 | 创建运动时无法选择关联计划 |

---

## 🎯 阶段 1：模块联动（优先级 P1）

### 任务 1.1：运动记录关联计划

**目标**：记录运动时可以选择关联计划，保存后自动完成今日相关任务

**修改文件**：
| 文件 | 修改内容 |
|------|----------|
| `workout_edit_page.dart` | 添加计划选择器 |
| `workout_repository.dart` | 添加关联查询方法 |
| `plan_repository.dart` | 添加根据运动类型查找任务的方法 |

**新增 UI 组件**：
```
lib/features/workout/presentation/widgets/plan_selector.dart
```

**业务逻辑**：
1. 保存运动时如果选择了关联计划
2. 查找该计划今日的运动类型任务
3. 自动标记任务为完成
4. 刷新计划进度

**预计工作量**：2-3 小时

---

### 任务 1.2：创建任务关联提醒

**目标**：创建计划任务时可选择添加提醒

**修改文件**：
| 文件 | 修改内容 |
|------|----------|
| `plans_page.dart` | 任务弹窗添加"设置提醒"开关 |
| `plan_repository.dart` | 创建任务时同步创建提醒 |
| `notification_service.dart` | 调用推送服务 |

**业务逻辑**：
1. 用户选择"设置提醒"
2. 显示时间选择器
3. 保存任务后同时创建提醒
4. 设置 reminderId 关联

**预计工作量**：1-2 小时

---

### 任务 1.3：运动后生成笔记

**目标**：运动保存成功后询问是否生成小结笔记

**修改文件**：
| 文件 | 修改内容 |
|------|----------|
| `workout_edit_page.dart` | 保存成功后弹出对话框 |
| `note_repository.dart` | 添加创建运动小结方法 |

**业务逻辑**：
1. 运动保存成功后 showDialog 询问"是否生成运动小结？"
2. 如果确认，自动创建笔记
3. 标题：运动类型 + 日期
4. 内容：运动时长、感受、备注等
5. 设置 linkedNoteId 关联

**笔记模板**：
```
# 运动小结 - 跑步 (2026-01-30)

运动类型：跑步
运动时长：30 分钟
运动感受：适中

备注：
今天跑了3公里，感觉不错！
```

**预计工作量**：1-2 小时

---

## 🏠 阶段 2：首页数据汇总（优先级 P1）

### 任务 2.1：今日概览真实数据

**目标**：显示真实的任务完成情况和运动时长

**修改文件**：
| 文件 | 修改内容 |
|------|----------|
| `home_page.dart` | 连接 Provider 获取真实数据 |
| `plan_providers.dart` | 添加今日任务统计 Provider |

**需要显示的数据**：
| 项目 | 数据来源 |
|------|----------|
| 今日完成任务数 | taskStatsProvider |
| 今日运动时长 | thisWeekStatsProvider |
| 待处理提醒数 | pendingRemindersProvider |

**预计工作量**：1-2 小时

---

### 任务 2.2：最近动态列表

**目标**：显示最近的笔记、运动、任务完成记录

**新增 Provider**：
```
lib/core/providers/activity_provider.dart
```

**新增 UI 组件**：
```
lib/shared/widgets/recent_activity_item.dart
```

**预计工作量**：2-3 小时

---

## 🔔 阶段 3：通知推送集成（优先级 P1）

### 任务 3.1：提醒保存时设置推送

**目标**：创建/编辑提醒时调用本地推送服务

**修改文件**：
| 文件 | 修改内容 |
|------|----------|
| `reminders_page.dart` | 调用 NotificationService |
| `reminder_providers.dart` | 添加保存提醒的 Provider |

**业务逻辑**：
1. 保存提醒到数据库
2. 调用 notificationService.scheduleNotification()
3. 传入提醒ID、时间、标题

**预计工作量**：1 小时

---

### 任务 3.2：权限请求

**目标**：首次使用时请求通知权限

**修改文件**：
| 文件 | 修改内容 |
|------|----------|
| `main.dart` | 初始化时请求权限 |
| `notification_service.dart` | 添加权限检查方法 |

**预计工作量**：0.5 小时

---

## 📋 完整任务清单

### Sprint 1（优先级最高）

| # | 任务 | 预计时间 | 依赖 |
|---|------|----------|------|
| 1 | 运动记录添加计划选择器 | 1.5h | - |
| 2 | 运动保存自动完成关联任务 | 1h | 任务1 |
| 3 | 首页显示真实统计数据 | 2h | - |
| 4 | 提醒保存时设置推送 | 1h | - |
| 5 | 请求通知权限 | 0.5h | - |

**Sprint 1 小计**：6 小时

---

### Sprint 2（次优先级）

| # | 任务 | 预计时间 | 依赖 |
|---|------|----------|------|
| 6 | 创建任务时添加提醒选项 | 1.5h | - |
| 7 | 运动后生成笔记功能 | 2h | - |
| 8 | 最近动态列表实现 | 2.5h | - |
| 9 | 运动笔记关联跳转 | 1h | 任务7 |

**Sprint 2 小计**：7 小时

---

### Sprint 3（优化体验）

| # | 任务 | 预计时间 | 说明 |
|---|------|----------|------|
| 10 | 提醒重复功能完善 | 2h | 处理重复提醒逻辑 |
| 11 | 空状态页面引导 | 1h | 首次使用引导 |
| 12 | 加载状态优化 | 1h | 骨架屏 |
| 13 | 错误处理统一 | 1h | 错误提示优化 |

**Sprint 3 小计**：5 小时

---

## 🗂️ 新增文件清单

### 需要创建的新文件

| 文件路径 | 说明 |
|----------|------|
| `lib/features/workout/presentation/widgets/plan_selector.dart` | 计划选择器 |
| `lib/shared/widgets/recent_activity_item.dart` | 动态列表项 |
| `lib/core/providers/activity_provider.dart` | 动态聚合 Provider |

---

## 🔧 需要修改的现有文件

| 文件 | 修改类型 | 修改内容 |
|------|----------|----------|
| `workout_edit_page.dart` | 修改 | 添加计划选择、保存后询问生成笔记 |
| `workout_repository.dart` | 新增方法 | 关联查询方法 |
| `plan_repository.dart` | 新增方法 | 按运动类型查找任务 |
| `plans_page.dart` | 修改 | 任务弹窗添加提醒选项 |
| `home_page.dart` | 修改 | 连接真实数据 Provider |
| `reminders_page.dart` | 修改 | 调用推送服务 |
| `main.dart` | 修改 | 初始化通知权限 |
| `notification_service.dart` | 修改 | 添加权限检查 |

---

## 📝 实现顺序建议

### 第一天：核心联动（4-5h）
1. ✅ 运动记录添加计划选择器（1.5h）
2. ✅ 运动保存自动完成任务（1h）
3. ✅ 提醒保存设置推送（1h）
4. ✅ 请求通知权限（0.5h）

### 第二天：首页数据（2-3h）
1. ✅ 首页真实统计数据（2h）
2. ✅ 测试联动功能（1h）

### 第三天：完善功能（3-4h）
1. ✅ 创建任务添加提醒（1.5h）
2. ✅ 运动生成笔记（2h）
3. ✅ 最近动态列表（可选）

---

## ✅ 验收标准

### 功能验收
- [ ] 创建运动记录可选择关联计划
- [ ] 保存运动后关联任务自动完成
- [ ] 首页显示真实的任务和运动数据
- [ ] 创建提醒后手机收到推送通知
- [ ] 运动保存后可生成笔记小结
- [ ] 创建任务时可添加提醒

### 技术验收
- [ ] `flutter analyze` 无错误
- [ ] 真机测试通过
- [ ] 数据关联正确保存
- [ ] 无内存泄漏

---

## 🚀 后续计划（P2-P3）

### P2 - 体验优化
- 页面切换动画
- 卡片点击反馈
- 深色模式完善
- 数据导出/导入

### P3 - AI 集成
- DeepSeek API 接入
- 智能计划生成
- AI 运动小结

---

## 📌 开发注意事项

### 代码生成
修改数据库后运行：
```bash
dart run build_runner build --delete-conflicting-outputs
```

### Provider 刷新
修改数据后记得 `ref.invalidate()` 刷新相关 Provider

### 导航使用
使用 `context.go()` 而非 `Navigator.push()`

### drift 导入
使用 `import 'package:drift/drift.dart' as drift;` 避免冲突

### 测试设备
Seeker (SM02G4061983569)

---

## 🔨 快速启动命令

### 编译命令（PowerShell）
```powershell
# 进入项目目录
cd 'G:\8.CC\ThickNotepad'

# 获取依赖
& 'G:\8.CC\flutter\bin\flutter.bat' pub get

# 构建 Debug APK
& 'G:\8.CC\flutter\bin\flutter.bat' build apk --debug

# 真机运行
& 'G:\8.CC\flutter\bin\flutter.bat' run -d SM02G4061983569
```

### 代码分析
```powershell
& 'G:\8.CC\flutter\bin\flutter.bat' analyze
```

### 清理缓存
```powershell
& 'G:\8.CC\flutter\bin\flutter.bat' clean
```

---

## 📚 技术栈回顾

| 技术 | 版本 | 用途 | 状态 |
|------|------|------|------|
| Flutter | 3.38.8 | UI 框架 | ✅ |
| Dart | 3.10.7 | 开发语言 | ✅ |
| Riverpod | 2.6.1 | 状态管理 | ✅ |
| Drift | 2.28.2 | 数据库 | ✅ |
| go_router | 14.8.1 | 路由管理 | ✅ |
| flutter_local_notifications | 17.2.4 | 推送通知 | ✅ |
| intl | 0.19.0 | 国际化 | ✅ |

---

## ❓ 问题排查

### 编译错误
```powershell
flutter clean
flutter pub get
flutter run
```

### 数据库问题
删除数据库文件重新生成：
```bash
# Android: 应用设置 -> 清除数据
```

### Windows 开发者模式
如果编译报错需要符号链接：
```
Win + R → ms-settings:developers → 开启开发者模式
```

---

## 📖 文档索引

| 文档 | 说明 |
|------|------|
| `docs/需求说明.md` | 完整项目需求文档 |
| `docs/Plan_Task.md` | 详细项目进度跟踪 |
| `docs/Changed.md` | 代码修改历史 |
| `docs/编译说明.md` | 编译指南和问题排查 |
| `docs/技术架构方案.md` | 技术栈设计文档 |

---

**文档版本**：V3.0
**创建日期**：2026-01-30
**预计总工作量**：18 小时（约 3-4 天）

---

## 📋 代码审查后状态 (2026-01-30)

### 已完成工作

| 类别 | 内容 |
|------|------|
| **严重问题修复** | 6 个 |
| **中等问题修复** | 4 个 |
| **性能优化** | 并行加载 ~60% 提升 |
| **工具类提取** | ProviderInvalidator, DateFormatter |

### 下一步推荐

根据当前项目稳定状态，建议按以下优先级进行开发：

#### 🔴 优先级 P0 - 核心联动功能

1. **运动记录关联计划**
   - 添加计划选择器
   - 保存后自动完成今日任务
   - 预计时间：2-3 小时

2. **首页真实数据展示**
   - 替换硬编码数据为真实 Provider
   - 显示实际任务完成情况
   - 预计时间：1-2 小时

3. **通知推送集成**
   - 提醒保存时调用推送服务
   - 首次使用请求权限
   - 预计时间：1.5 小时

#### 🟡 优先级 P1 - 功能增强

4. **任务关联提醒**
   - 创建任务时可添加提醒
   - 预计时间：1.5 小时

5. **运动生成笔记**
   - 运动保存后询问生成小结
   - 预计时间：1-2 小时

6. **最近动态列表**
   - 聚合各模块最新记录
   - 预计时间：2-3 小时

#### 🟢 优先级 P2 - 体验优化

7. UI 动画优化
8. 深色模式完善
9. 数据备份恢复

### 技术债务已清理 ✅

- ✅ Provider 刷新逻辑统一
- ✅ 日期格式化集中管理
- ✅ 时区硬编码修复
- ✅ 内存泄漏修复

### 编译环境确认

```
Flutter: 3.38.8
Dart: 3.10.7
设备: Seeker (SM02G4061983569)
状态: 稳定运行
```
